generator client {
  provider = "prisma-client-py"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
enum UserRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
  INSTRUCTOR
  STUDENT
  STUDENT_PREMIUM
  TEACHING_ASSISTANT
  CONTENT_REVIEWER
  SUPPORT
}

enum AuthType {
  PASSWORD
  GOOGLE
  GITHUB
  FACEBOOK
  LINKEDIN
  MICROSOFT
  APPLE
  SSO_ENTERPRISE
  SAML
  OAUTH2
}

model User {
  id                  String    @id @default(uuid())
  username            String    @unique
  email               String    @unique
  passwordHash        String
  role                UserRole  @default(STUDENT)

  isEmailVerified     Boolean   @default(false)
  isPhoneVerified     Boolean   @default(false)
  emailVerificationToken String?
  emailVerificationExpires DateTime?

  isActive            Boolean   @default(true)
  isSuspended         Boolean   @default(false)
  suspensionReason    String?

  mfaEnabled          Boolean   @default(false)
  mfaSecret           String?
  backupCodes         String[]

  lastLoginAt         DateTime?
  lastLoginIp         String?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  resetPasswordToken  String?
  resetPasswordExpires DateTime?

  authProvider        AuthType  @default(PASSWORD)
  authProviderId      String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  sessions            Session[]
  refreshTokens       RefreshToken[]
  loginHistory        LoginHistory[]

  @@index([email, username])
  @@map("users")
}

model Session {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade) 
  token           String    @unique
  expiresAt       DateTime
  ipAddress       String?
  userAgent       String?
  device          String?
  isValid         Boolean   @default(true)
  createdAt       DateTime  @default(now())
  @@index([userId, isValid])
  @@index([token])
  @@map("sessions")
}

model RefreshToken {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token           String    @unique
  expiresAt       DateTime
  isRevoked       Boolean   @default(false)
  revokedAt       DateTime?
  deviceId        String?
  ipAddress       String?
  createdAt       DateTime  @default(now())
  @@index([userId, isRevoked])
  @@index([token])
  @@map("refresh_tokens")
}

model LoginHistory {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  success         Boolean
  failureReason   String?
  ipAddress       String?
  userAgent       String?
  location        String?
  country         String?
  city            String?
  device          String?
  browser         String?
  os              String?
  loginAt         DateTime  @default(now())
  @@index([userId, loginAt])
  @@map("login_history")
}